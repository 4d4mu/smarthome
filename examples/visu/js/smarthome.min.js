var shVersion=0.71;var shWS=false;var shLock=false;var shRRD={};var shURL="";var shBuffer={};var shOpt={};var shMonitor=[];Array.prototype.diff=function(b){return this.filter(function(a){return !(b.indexOf(a)>-1)})};function shUnique(a){a=a.sort();var b=[a[0]];for(var c=1;c<a.length;c++){if(a[c-1]!==a[c]){b.push(a[c])}}return b}function shInit(a){shURL=a;shWsInit();setTimeout(shWSCheckInit,2000);$(window).unload(function(){shWS.close();shWS=null});$(document).on("pagecreate",function(){shPageCreate()});$(document).on("pageinit",function(){shPageInit()});$(document).on("pageshow",function(){shPageShow()});$(document).on("click","a[data-logic]",function(){shTriggerLogic(this)});$(document).on("click","img[data-logic]",function(){shTriggerLogic(this)});$(document).on("click","img.switch[data-sh]",function(){shSwitchButton(this)});$(document).on("click","img.set[data-sh]",function(){shSendFix(this)});$(document).on("vmousedown","img.push[data-sh]",function(b){b.preventDefault();shSendPush(this,true)});$(document).on("vmouseup","img.push[data-sh]",function(){shSendPush(this,false)});$(document).on("change","select[data-sh]",function(){shSendSelect(this)});$(document).on("change",'input[data-sh][data-type="range"]',function(){shSendNum(this)});$(document).on("change",'input[data-sh][type="time"]',function(){shSendVal(this)});$(document).on("change","input[data-sh]:text",function(){shSendVal(this)});$(document).on("change","textarea[data-sh]",function(){shSendVal(this)});$(document).on("change",'input[data-sh][type="checkbox"]',function(){shSendCheckbox(this)});$(document).on("change",'input[data-sh][type="radio"]',function(){shSendRadio(this)})}function shRRDUpdate(g){var a,b,f,k,j;if("frame" in g){a=g.id;var e=g.start*1000;var c=g.step*1000;var h=[];b=g.frame;for(i=0;i<g.data.length;i++){h.push([e,g.data[i]]);e+=c}if(a in shRRD){shRRD[a][b]=h}else{shRRD[a]={};shRRD[a][b]=h}$.mobile.activePage.find($("[data-rrd]")).each(function(){f=$(this).attr("data-rrd").split("|");for(i=0;i<f.length;i++){rrd=f[i].split("=");if(rrd[0]==a){b=$(this).attr("data-frame");if(a in shRRD){if(b in shRRD[a]){shRRDDraw(this)}}break}}})}else{var e=g.time*1000;for(k in g.data){a=g.data[k][0];j=g.data[k][1];if(a in shRRD){for(b in shRRD[a]){if(b.search(/^([0-9]+h)|([1-7]d)/)!=-1){shRRD[a][b].shift()}shRRD[a][b].push([e,j])}}}$.mobile.activePage.find($("[data-rrd]")).each(function(){shRRDDraw(this)})}}function shRRDDraw(f){var a=$(f).attr("data-rrd").split("|");var e=$(f).attr("data-frame");var b=[];for(i=0;i<a.length;i++){var c={};rrd=a[i].split("=");var d=rrd[0];if(d in shRRD){if(e in shRRD[d]){if(rrd[1]!=undefined){c=JSON.parse("{"+rrd[1].replace(/'/g,'"')+"}")}else{c={}}c.data=shRRD[d][e];b.push(c)}}}if(b.length>0){$.plot($(f),b,{xaxis:{mode:"time"}})}}function shWsInit(){shWS=new WebSocket(shURL);shWS.onopen=function(){shSend(["SmartHome.py",1]);shRequestData();$(".ui-dialog").dialog("close")};shWS.onmessage=function(b){var d,e;var c=JSON.parse(b.data);console.log("receiving data: "+b.data);command=c[0];delete c[0];switch(command){case"item":for(var a=1;a<c.length;a++){d=c[a][0];e=c[a][1];if(c[a].length>2){shOpt[d]=c[a][2]}shLock=d;shBuffer[d]=e;shUpdateItem(d,e);shLock=false}break;case"rrd":shRRDUpdate(c[1]);break;case"dialog":shDialog(c[1][0],c[1][1]);break}};shWS.onerror=function(a){console.log("Websocket error: "+a)};shWS.onclose=function(){shDialog("Network error","Could not connect to the backend!")}}function shWSCheckInit(){setInterval(shWSCheck,2000)}function shWSCheck(){if(shWS.readyState>1){shWsInit()}}function shRequestData(){shMonitor=$("[data-sh]").map(function(){if(this.tagName!="A"){return $(this).attr("data-sh")}}).get();shMonitor=shUnique(shMonitor);shSend(["monitor",shMonitor]);$("[data-rrd]").each(function(){var b=$(this).attr("data-rrd").split("|");var c=$(this).attr("data-frame");for(i=0;i<b.length;i++){var a=b[i].split("=");var d=a[0];if(!(d in shRRD)){shSend(["rrd",[a[0],c]])}else{if(!(c in shRRD[d])){shSend(["rrd",[a[0],c]])}}}})}function shPageCreate(){console.log("PageCreate");shRequestData();if($("#shDialog").length==0){$.mobile.pageContainer.append('<div data-role="page" id="shDialog"><div data-role="header"><h1 id="shDialogHeader"></h1></div><div data-role="content"><div id="shDialogContent"></div></div></div>')}}function shPageInit(){console.log("PageInit");for(path in shBuffer){if(shMonitor.indexOf(path)!=-1){shUpdateItem(path,shBuffer[path])}else{delete shBuffer[path];delete shOpt[path]}}}function shPageShow(){if(shWS.readyState>1){shWsInit()}$.mobile.activePage.find($("[data-rrd]")).each(function(){shRRDDraw(this)})}function shSend(a){if(shWS.readyState>1){shWsInit()}if(shWS.readyState==1){console.log("sending data: "+a);shWS.send(unescape(encodeURIComponent(JSON.stringify(a))));return true}else{console.log("Websocket ("+shURL+") not available. Could not send data.");return false}}function shBufferUpdate(a,c,b){if(a in shBuffer){if(shBuffer[a]!==c){console.log(a+" changed to: "+c+" ("+typeof(c)+")");shBuffer[a]=c;shSend(["item",[a,c]]);shUpdateItem(a,c,b)}}}function shTriggerLogic(a){shSend(["logic",[$(a).attr("data-logic"),$(a).attr("value")]])}function shSwitchButton(b){var a=$(b).attr("data-sh");var c=true;if(String($(b).val())=="1"){c=false}shBufferUpdate(a,c,b);$(b).val(Number(c));$(b).attr("src",shOpt[a][Number(c)])}function shSendSelect(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c;if($(b).attr("data-role")=="slider"){c=Boolean($(b)[0].selectedIndex)}else{c=$(b).val()}shBufferUpdate(a,c,b)}function shSendFix(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=Number($(b).attr("value"));shBufferUpdate(a,c,b)}function shSendPush(b,c){var a=$(b).attr("data-sh");if(a==shLock){return}shBufferUpdate(a,c,b)}function shSendVal(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).val();shBufferUpdate(a,c,b)}function shSendNum(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=Number($(b).val());shBufferUpdate(a,c,b)}function shSendRadio(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).val();shBufferUpdate(a,c,b)}function shSendCheckbox(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).prop("checked");shBufferUpdate(a,c,b)}function shUpdateItem(d,g,f){var c=$('[data-sh="'+d+'"]');if(c.length==0){console.log("unknown id: "+d);return}$(c).filter('[type!="radio"]').each(function(){element=this.tagName;if(f==this){return true}switch(element){case"DIV":$(this).html(g);break;case"SPAN":$(this).html(g);break;case"TEXTAREA":$(this).val(g);break;case"SELECT":updateSelect(this,g);break;case"INPUT":updateInput(this,g);break;case"IMG":if($(this).attr("class")!="set"){if(d in shOpt){$(this).attr("src",shOpt[d][Number(g)]);$(this).val(Number(g))}else{$(this).attr("src",g)}}break;default:console.log("unknown element: "+element);break}});var a=$(c).filter('[type="radio"]');a.removeAttr("checked");a.filter("[value='"+g+"']").attr("checked","checked");try{$(a).checkboxradio("refresh")}catch(b){}}function updateSelect(b,c){if($(b).attr("data-role")=="slider"){b.selectedIndex=c;try{$(b).slider("refresh")}catch(a){}}else{$(b).val(c);try{$(b).selectmenu("refresh")}catch(a){}}}function updateInput(c,d){var a=$(c).attr("type");if(a==undefined){a=$(c).attr("data-type")}switch(a){case"text":$(c).val(d);break;case"range":try{$(c).val(d).slider("refresh")}catch(b){}break;case"number":try{$(c).val(d).slider("refresh")}catch(b){}break;case"checkbox":try{$(c).attr("checked",d).checkboxradio("refresh")}catch(b){}break;case"image":$(c).val(Number(d));$(c).attr("src",shOpt["example.toggle"][Number(d)]);break;case"time":$(c).val(d);break;default:console.log("unknown type: "+a);break}}function shDialog(b,a){$("#shDialogHeader").html(b);$("#shDialogContent").html(a);$.mobile.changePage("#shDialog",{transition:"pop",role:"dialog"})};