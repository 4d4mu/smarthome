var shProto=1;var shWS=false;var shLock=false;var shRRD={};var shLog={};var shURL="";var shBuffer={};var shOpt={};var shMonitor=[];Array.prototype.diff=function(b){return this.filter(function(a){return !(b.indexOf(a)>-1)})};function shUnique(a){a=a.sort();var b=[a[0]];for(var c=1;c<a.length;c++){if(a[c-1]!==a[c]){b.push(a[c])}}return b}function shPushCycle(c,b,a){shSendPush(c,a);$(c).data("cycle",setTimeout(function(){shPushCycle(c,b,a)},b))}function shInit(a){shURL=a;shWsInit();setTimeout(shWSCheckInit,2000);$(window).unload(function(){shWS.close();shWS=null});$(document).on("pagecreate",function(){shPageCreate()});$(document).on("pageinit",function(){shPageInit()});$(document).on("pageshow",function(){shPageShow()});$(document).on("click","a[data-logic]",function(){shTriggerLogic(this)});$(document).on("click","img[data-logic]",function(){shTriggerLogic(this)});$(document).on("click","img.switch[data-sh]",function(){shSwitchButton(this)});$(document).on("click","img.set[data-sh]",function(){shSendFix(this)});$(document).on("vmousedown","img.push[data-sh]",function(d){d.preventDefault();var e=true;var c=$(this).attr("data-cycle");if(c==undefined){c=1000}else{c=parseInt(c)}var b=$(this).attr("data-arr");if(b!=undefined){e=[parseInt(b),1]}var f=$(this).attr("data-sh");shPushCycle(this,c,e)});$(document).on("vmouseup","img.push[data-sh]",function(){clearTimeout($(this).data("cycle"));var c=false;var b=$(this).attr("data-arr");if(b!=undefined){c=[parseInt(b),0]}var d=$(this).attr("data-sh");shSendPush(this,c)});$(document).on("change","select[data-sh]",function(){shSendSelect(this)});$(document).on("change",'input[data-sh][data-type="range"]',function(){shSendNum(this)});$(document).on("change",'input[data-sh][type="time"]',function(){shSendVal(this)});$(document).on("change","input[data-sh]:text",function(){shSendVal(this)});$(document).on("change","textarea[data-sh]",function(){shSendVal(this)});$(document).on("change",'input[data-sh][type="checkbox"]',function(){shSendCheckbox(this)});$(document).on("change",'input[data-sh][type="radio"]',function(){shSendRadio(this)})}function shLogUpdate(d){var f,e,a,g;for(var c=0;c<d.p.length;c++){f=d.p[c][0];e=$('[data-log="'+f+'"]');if(e.length==0){return}g=d.p[c][1];if("i" in d){$(e).html("")}for(var b=g.length-1;b>=0;b--){$(e).prepend(g[b]+"\n")}a=$(e).attr("data-max");if(a!=undefined){a=parseInt(a);while($(e).children().length>a){$(e).children().last().remove()}}$(e).listview("refresh")}}function shRRDUpdate(g){var a,e,c,b,f,k,j;if("f" in g){a=g.p[0][0];e=g.s*1000;c=g.d*1000;var h=[];b=g.f;for(i=0;i<g.p[0][1].length;i++){h.push([e,g.p[0][1][i]]);e+=c}if(a in shRRD){shRRD[a][b]=h}else{shRRD[a]={};shRRD[a][b]=h}$.mobile.activePage.find($("[data-rrd]")).each(function(){f=$(this).attr("data-rrd").split("|");for(i=0;i<f.length;i++){rrd=f[i].split("=");if(rrd[0]==a){b=$(this).attr("data-frame");if(a in shRRD){if(b in shRRD[a]){shRRDDraw(this)}}break}}})}else{var e=g.t*1000;for(k in g.p){a=g.p[k][0];j=g.p[k][1];if(a in shRRD){for(b in shRRD[a]){if(b.search(/^([0-9]+h)|([1-7]d)/)!=-1){shRRD[a][b].shift()}shRRD[a][b].push([e,j])}}}$.mobile.activePage.find($("[data-rrd]")).each(function(){shRRDDraw(this)})}}function shRRDDraw(g){var a=$(g).attr("data-rrd").split("|");var f=$(g).attr("data-frame");var c=[];var b={xaxis:{mode:"time"}};if($(g).attr("data-options")){b=JSON.parse("{"+$(g).attr("data-options").replace(/'/g,'"')+"}")}for(i=0;i<a.length;i++){var d={};rrd=a[i].split("=");var e=rrd[0];if(e in shRRD){if(f in shRRD[e]){if(rrd[1]!=undefined){d=JSON.parse("{"+rrd[1].replace(/'/g,'"')+"}")}else{d={}}d.data=shRRD[e][f];c.push(d)}}}if(c.length>0){$.plot($(g),c,b)}}function shWsInit(){shWS=new WebSocket(shURL);shWS.onopen=function(){shSend({k:"p",v:shProto});shRRD={};shLog={};shRequestData();$(".ui-dialog").dialog("close")};shWS.onmessage=function(c){var e,f;var d=JSON.parse(c.data);switch(d.k){case"i":for(var a=0;a<d.p.length;a++){e=d.p[a][0];f=d.p[a][1];if(d.p[a].length>2){shOpt[e]=d.p[a][2]}shLock=e;shBuffer[e]=f;shUpdateItem(e,f);shLock=false}break;case"r":shRRDUpdate(d);break;case"l":shLogUpdate(d);break;case"d":shDialog(d.h,d.c);break;case"p":var b=parseInt(d.p);if(b!=shProto){shDialog("Protcol missmatch","Update smarthome(.min).js")}break}};shWS.onerror=function(a){};shWS.onclose=function(){shDialog("Network error","Could not connect to the backend!")}}function shWSCheckInit(){setInterval(shWSCheck,2000)}function shWSCheck(){if(shWS.readyState>1){shWsInit()}}function shRequestData(){shMonitor=$("[data-sh]").map(function(){if(this.tagName!="A"){return $(this).attr("data-sh")}}).get();shMonitor=shUnique(shMonitor);shSend({k:"m",p:shMonitor});$("[data-rrd]").each(function(){var b=$(this).attr("data-rrd").split("|");var c=$(this).attr("data-frame");for(i=0;i<b.length;i++){var a=b[i].split("=");var d=a[0];if(!(d in shRRD)){shSend({k:"r",p:a[0],f:c})}else{if(!(c in shRRD[d])){shSend({k:"r",p:a[0],f:c})}}}});$("[data-log]").each(function(){var b=$(this).attr("data-log");var a=$(this).attr("data-max");if(!(b in shLog)){shSend({k:"l",l:b,m:a})}})}function shPageCreate(){shRequestData();if($("#shDialog").length==0){$.mobile.pageContainer.append('<div data-role="page" id="shDialog"><div data-role="header"><h1 id="shDialogHeader"></h1></div><div data-role="content"><div id="shDialogContent"></div></div></div>')}}function shPageInit(){for(path in shBuffer){if(shMonitor.indexOf(path)!=-1){shUpdateItem(path,shBuffer[path])}else{delete shBuffer[path];delete shOpt[path]}}}function shPageShow(){if(shWS.readyState>1){shWsInit()}$.mobile.activePage.find($("[data-rrd]")).each(function(){shRRDDraw(this)})}function shSend(a){if(shWS.readyState>1){shWsInit()}if(shWS.readyState==1){shWS.send(unescape(encodeURIComponent(JSON.stringify(a))));return true}else{return false}}function shBufferUpdate(a,c,b){if(a in shBuffer){if(shBuffer[a]!==c){shBuffer[a]=c;shSend({k:"i",p:a,v:c});shUpdateItem(a,c,b)}}}function shTriggerLogic(a){shSend({k:"c",l:$(a).attr("data-logic"),v:$(a).attr("value")})}function shSwitchButton(b){var a=$(b).attr("data-sh");var c=true;if(String($(b).val())=="1"){c=false}shBufferUpdate(a,c,b);$(b).val(Number(c));$(b).attr("src",shOpt[a][Number(c)])}function shSendSelect(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c;if($(b).attr("data-role")=="slider"){c=Boolean($(b)[0].selectedIndex)}else{c=$(b).val()}shBufferUpdate(a,c,b)}function shSendFix(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=Number($(b).attr("value"));shBufferUpdate(a,c,b)}function shSendPush(b,c){var a=$(b).attr("data-sh");if(a==shLock){return}shSend({k:"i",p:a,v:c})}function shSendVal(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).val();shBufferUpdate(a,c,b)}function shSendNum(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=Number($(b).val());shBufferUpdate(a,c,b)}function shSendRadio(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).val();shBufferUpdate(a,c,b)}function shSendCheckbox(b){var a=$(b).attr("data-sh");if(a==shLock){return}var c=$(b).prop("checked");shBufferUpdate(a,c,b)}function shUpdateItem(d,g,f){var c=$('[data-sh="'+d+'"]');if(c.length==0){return}$(c).filter('[type!="radio"]').each(function(){element=this.tagName;if(f==this){return true}switch(element){case"DIV":var e=$(c).attr("data-unit");if(e!=null){g=g+" "+e}$(this).html(g);break;case"SPAN":var e=$(c).attr("data-unit");if(e!=null){g=g+" "+e}$(this).html(g);break;case"TEXTAREA":$(this).val(g);break;case"SELECT":updateSelect(this,g);break;case"INPUT":updateInput(this,g);break;case"UL":updateList(this,g);break;case"IMG":if($(this).attr("class")!="set"&&$(this).attr("class")!="push"){if(d in shOpt){$(this).attr("src",shOpt[d][Number(g)]);$(this).val(Number(g))}else{$(this).attr("src",g)}}break;default:break}});var a=$(c).filter('[type="radio"]');a.removeAttr("checked");a.filter("[value='"+g+"']").attr("checked","checked");try{$(a).checkboxradio("refresh")}catch(b){}}function updateSelect(b,c){if($(b).attr("data-role")=="slider"){b.selectedIndex=c;try{$(b).slider("refresh")}catch(a){}}else{$(b).val(c);try{$(b).selectmenu("refresh")}catch(a){}}}function updateList(b,c){$(b).html("");for(var a=0;a<c.length;a++){$(b).append(c[a]+"\n")}$(b).listview("refresh")}function updateInput(c,d){var a=$(c).attr("type");if(a==undefined){a=$(c).attr("data-type")}switch(a){case"text":$(c).val(d);break;case"range":try{$(c).val(d).slider("refresh")}catch(b){}break;case"number":try{$(c).val(d).slider("refresh")}catch(b){}break;case"checkbox":try{$(c).attr("checked",d).checkboxradio("refresh")}catch(b){}break;case"image":$(c).val(Number(d));$(c).attr("src",shOpt["example.toggle"][Number(d)]);break;case"time":$(c).val(d);break;default:break}}function shDialog(b,a){$("#shDialogHeader").html(b);$("#shDialogContent").html(a);$.mobile.changePage("#shDialog",{transition:"pop",role:"dialog"})};